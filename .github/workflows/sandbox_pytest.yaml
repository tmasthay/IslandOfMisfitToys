---
name: GPU Validation Workflow

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  run_gpu_validation:
    runs-on: ubuntu-latest
    env:
      REMOTE_USER: ${{ secrets.REMOTE_USER }}
      REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: SSH into server + validate sandboxed pytest
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            GITHUB_HASH=${{ github.sha }}
            echo "SSH successful"
            echo "Commit: $GITHUB_HASH!"
            echo "Date: $(date)!"
            mkdir -p ~/.sandbox
            cd ~/.sandbox

            # source /home/tyler/anaconda3/etc/profile.d/conda.sh
            /home/tyler/anaconda3/bin/conda activate
            # eval "$(conda shell.bash hook)"

            # Check if the sandbox directory is empty
            if [ "$(ls -A)" ]; then
                echo "FAIL: Running another job currently"
                exit 2
            else
                echo "Directory is empty. Proceeding with tests..."

                # Ensure we are not in any conda environment
                conda deactivate

                # Removing the existing environment (if it exists)
                conda env remove --name dw_sandbox --yes || {
                    echo "FAIL: Failed to remove the existing conda environment."
                    exit 1
                }

                # Creating a new environment
                conda create -n dw_sandbox python=3.10 --yes || {
                    echo "FAIL: Failed to create a new conda environment."
                    exit 1
                }

                # Activating the new environment
                conda activate dw_sandbox

                # Initialize a new Git repository
                mkdir IslandOfMisfitToys && cd IslandOfMisfitToys
                git init || { echo "FAIL: Failed to initialize a git repository."; exit 1; }

                # Add the remote and fetch the specific commit
                git remote add origin https://github.com/tmasthay/IslandOfMisfitToys.git
                git fetch --depth 1 origin $GITHUB_HASH || {
                    echo "FAIL: Failed to fetch the commit $GITHUB_HASH."
                    exit 1
                }

                # Checkout the specific commit
                git checkout $GITHUB_HASH || {
                    echo "FAIL: Failed to checkout the commit $GITHUB_HASH."
                    exit 1
                }

                echo "Successfully set up the environment and checked out the commit."
                echo "CONDA_PREFIX=$CONDA_PREFIX"
                echo "PWD=$PWD"
                echo "pip=$(which pip)"
                echo "INSTALLING IOMT"
                time pip install -e . || {
                    echo "FAIL: Failed to install the package."
                    exit 3
                }
            fi
            pytest -s
            pytest_exit_code=$?
            false_failure_modes=$(ls tests/status)
            if [ $(echo $false_failure_modes | wc -w) -gt 0 ]; then
                for mode in $false_failure_modes; do
                    echo "FAIL: False failure mode detected: $mode"
                done
                exit 4
            fi
            exit $pytest_exit_code
